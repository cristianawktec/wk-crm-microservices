<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WK CRM - Login</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg,#6a82fb,#fc5c7d); }
    .login-box { width: 380px; }
  </style>
</head>
<body>
<div class="login-box">
  <div class="card card-outline card-primary">
    <div class="card-header text-center">
      <a href="#" class="h1"><b>WK</b> CRM</a>
    </div>
    <div class="card-body">
      <p class="login-box-msg">Faça login para continuar</p>
      <div id="alert-container"></div>
      <form id="loginForm">
        <div class="input-group mb-3">
          <input type="email" id="email" class="form-control" placeholder="Email" required>
          <div class="input-group-append">
            <div class="input-group-text"><span class="fas fa-envelope"></span></div>
          </div>
        </div>
        <div class="input-group mb-3">
          <input type="password" id="password" class="form-control" placeholder="Senha" required>
          <div class="input-group-append">
            <div class="input-group-text"><span class="fas fa-lock"></span></div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <button type="submit" id="btnLogin" class="btn btn-primary btn-block">Entrar</button>
          </div>
        </div>
      </form>
      <p class="mt-3 mb-0 text-muted" style="font-size:12px">Dica: admin@consultoriawk.com / Admin@123</p>
    </div>
  </div>
</div>

<script src="js/api-connection.js"></script>
<script>
  const alertContainer = document.getElementById('alert-container');
  function showError(msg){
    alertContainer.innerHTML = `<div class="alert alert-danger alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  }
  function showSuccess(msg){
    alertContainer.innerHTML = `<div class="alert alert-success alert-dismissible fade show" role="alert">${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  }

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = (document.getElementById('email') as HTMLInputElement).value.trim();
    const password = (document.getElementById('password') as HTMLInputElement).value;
    const btn = document.getElementById('btnLogin');
    btn.setAttribute('disabled','true');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entrando...';
    try {
      const res = await wkAPI.login(email, password);
      if(res?.token){
        showSuccess('Login realizado com sucesso!');
        const params = new URLSearchParams(window.location.search);
        const next = params.get('next') || 'index.html';
        window.location.href = next;
      } else {
        showError(res?.message || 'Falha no login');
      }
    } catch (err){
      showError('Credenciais inválidas ou erro no servidor');
    } finally {
      btn.removeAttribute('disabled');
      btn.innerHTML = 'Entrar';
    }
  });
</script>
</body>
</html>
