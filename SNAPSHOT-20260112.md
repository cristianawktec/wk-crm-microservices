# ğŸ“¸ Snapshot do Sistema - 12/01/2026 21:18

## âœ… Status: TUDO FUNCIONANDO

### O que estÃ¡ operacional:

#### ğŸ¨ Frontend
- âœ… **Vue Customer Portal** (app.consultoriawk.com)
  - Login/autenticaÃ§Ã£o com Sanctum
  - Dashboard com resumo de oportunidades
  - Lista de oportunidades (CRUD completo)
  - **PÃ¡gina de detalhes de oportunidades** (CORRIGIDA hoje)
  - Perfil do usuÃ¡rio
  - NotificaÃ§Ãµes em tempo real (SSE)
  - Sistema de toasts

- âœ… **Angular Admin** (api.consultoriawk.com/admin/)
  - Dashboard com mÃ©tricas
  - CRUD de clientes
  - CRUD de leads
  - CRUD de oportunidades
  - RelatÃ³rios e analytics
  - GrÃ¡ficos (Chart.js)

#### ğŸ”§ Backend
- âœ… **Laravel 11** (api.consultoriawk.com/api/)
  - AutenticaÃ§Ã£o Sanctum
  - Endpoints de customer dashboard
  - **CustomerDashboardController::getOpportunityById()** (NEW)
  - Sistema de notificaÃ§Ãµes SSE
  - Envio de emails (SMTP Titan configurado)
  - CORS configurado

#### ğŸ˜ Banco de Dados
- âœ… **PostgreSQL 15**
  - Tabelas: customers, opportunities, leads, sellers, notifications
  - UUIDs como primary keys
  - Demo data para testes

#### ğŸš€ Infraestrutura
- âœ… **VPS Hostinger** (72.60.254.100)
  - Docker Compose com 8 serviÃ§os
  - Nginx reverse proxy
  - SSL Let's Encrypt
  - Fail2ban configurado

### ğŸ› Problema Resolvido Hoje

**Sintoma:** PÃ¡gina de detalhes de oportunidades em branco

**Causa Raiz:** 
1. API retornando HTTP 500 por erro de UUID casting no Laravel
2. Nginx servindo de diretÃ³rio errado (`/var/www/html/public/app` ao invÃ©s de `/var/www/customer`)

**SoluÃ§Ã£o:**
1. Criado mÃ©todo `getOpportunityById(string $id)` sem model binding
2. Nova rota `/api/customer-opportunities/show/{id}`
3. Corrigido Nginx: `root /var/www/customer;`
4. Cache limpo e permissÃµes ajustadas

### ğŸ“ Estrutura de Arquivos (VPS)

```
/var/www/
â”œâ”€â”€ customer/                    # Vue Customer Portal
â”‚   â”œâ”€â”€ index.html (404 bytes)
â”‚   â””â”€â”€ assets/
â”‚       â”œâ”€â”€ index-1f1c3a54.js
â”‚       â”œâ”€â”€ OpportunityDetailView-9cb9f9f1.js
â”‚       â””â”€â”€ ...
â”‚
â”œâ”€â”€ html/
â”‚   â””â”€â”€ wk-crm-laravel/          # Laravel Backend (host)
â”‚       â”œâ”€â”€ app/
â”‚       â”‚   â””â”€â”€ Http/Controllers/Api/
â”‚       â”‚       â””â”€â”€ CustomerDashboardController.php (UPDATED)
â”‚       â””â”€â”€ routes/
â”‚           â””â”€â”€ api.php (NEW ROUTE)
â”‚
â””â”€â”€ admin/                        # Angular Admin (nÃ£o verificado)
```

### ğŸ³ Docker Containers

```
wk_crm_laravel     # Laravel (porta 8000)
wk_postgres        # PostgreSQL (porta 5433)
wk_gateway         # Gateway (porta 3000)
wk_products_api    # Products API (porta 3001)
wk_ai_service      # AI Service (porta 8001)
wk_admin_frontend  # Angular (porta 4200)
wk_customer_app    # Vue (porta 5173)
wk_crm_dotnet      # .NET Demo (porta 5000)
```

### ğŸ”‘ ConfiguraÃ§Ãµes Importantes

#### Nginx (`/etc/nginx/sites-enabled/app.consultoriawk.com`)
```nginx
root /var/www/customer;  # â† CORRIGIDO HOJE
location / {
    try_files $uri $uri/ /index.html;  # SPA fallback
}
location /api/ {
    proxy_pass http://localhost:8000;  # Laravel
}
```

#### Laravel Routes (`routes/api.php`)
```php
// Nova rota (ANTES da rota com model binding)
Route::get('/customer-opportunities/show/{id}', 
    [CustomerDashboardController::class, 'getOpportunityById']);

Route::get('/customer-opportunities/{opportunity}', 
    [CustomerDashboardController::class, 'getOpportunity']);
```

### ğŸ”— URLs Funcionais

| ServiÃ§o | URL | Status |
|---------|-----|--------|
| Customer Portal | https://app.consultoriawk.com | âœ… 200 |
| Detalhes Oportunidade | https://app.consultoriawk.com/opportunities/{uuid} | âœ… 200 |
| Admin Portal | https://api.consultoriawk.com/admin/ | âœ… 200 |
| API Laravel | https://api.consultoriawk.com/api/ | âœ… 200 |
| NotificaÃ§Ãµes SSE | https://api.consultoriawk.com/api/notifications/stream | âœ… 200 |

### ğŸ“Š API Testada

**Endpoint:** `GET /api/customer-opportunities/show/{id}`

**Request:**
```bash
curl 'https://api.consultoriawk.com/api/customer-opportunities/show/a39632f3-d114-4133-b66c-645496a344ef' \
  -H 'Authorization: Bearer {token}'
```

**Response:** (200 OK)
```json
{
  "success": true,
  "data": {
    "id": "a39632f3-d114-4133-b66c-645496a344ef",
    "title": "ImplantaÃ§Ã£o CRM - Fase 1",
    "value": "45000.00",
    "status": "open",
    "probability": 40,
    "seller_id": null,
    "seller": "NÃ£o atribuÃ­do",
    "created_at": "2026-01-12T17:51:24-03:00",
    "notes": ""
  }
}
```

### ğŸ’¾ Backups Criados

1. **Snapshot VPS** (Hostinger): `wk-crm-working-20260112`
2. **Dump PostgreSQL**: 
   - Servidor: `/root/backup-wk-.sql` (28KB)
   - Local: `c:\xampp\htdocs\crm\backups\backup-20260112-211849.sql`

### ğŸ§ª Como Restaurar

#### OpÃ§Ã£o 1: Restaurar Snapshot (VPS completo)
1. Painel Hostinger â†’ Snapshots e Backups
2. Selecionar snapshot `wk-crm-working-20260112`
3. Clicar "Restaurar"
4. Aguardar 5-10 minutos

#### OpÃ§Ã£o 2: Restaurar apenas Banco
```bash
# No servidor VPS
cat /root/backup-wk-.sql | docker exec -i wk_postgres psql -U wk_user wk_main

# Ou da mÃ¡quina local
cat c:\xampp\htdocs\crm\backups\backup-20260112-211849.sql | \
  ssh root@72.60.254.100 "docker exec -i wk_postgres psql -U wk_user wk_main"
```

### ğŸ“ Credenciais (para referÃªncia)

#### Banco de Dados
```env
DB_HOST=127.0.0.1
DB_PORT=5433
DB_DATABASE=wk_main
DB_USERNAME=wk_user
DB_PASSWORD=secure_password_123
```

#### Email (SMTP)
```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.titan.email
MAIL_PORT=465
MAIL_USERNAME=noreply@consultoriawk.com
MAIL_ENCRYPTION=ssl
```

### ğŸ¯ PrÃ³ximos Passos (Roadmap)

Conforme [PROXIMOS-PASSOS-PRIORIDADES.en.md](PROXIMOS-PASSOS-PRIORIDADES.en.md):

1. **Priority 2** (5% restante): Completar sistema de notificaÃ§Ãµes
   - NotificaÃ§Ãµes em mudanÃ§a de status/valor
   - Testes multi-usuÃ¡rio

2. **Priority 3**: IntegraÃ§Ãµes AI (FastAPI + Google Gemini)
   - AnÃ¡lise de risco
   - Chatbot de suporte

3. **Priority 4**: Admin Simple (AdminLTE)
   - EdiÃ§Ã£o de clientes
   - Deploy produÃ§Ã£o

4. **Priority 5**: Melhorias gerais
   - PaginaÃ§Ã£o
   - Testes unitÃ¡rios
   - Sistema de permissÃµes

### âš ï¸ Notas Importantes

- **Ordem das rotas** no Laravel: `/show/{id}` DEVE vir ANTES de `/{opportunity}` para evitar conflitos
- **PermissÃµes** do diretÃ³rio customer: `www-data:www-data` com `755`
- **Cache do Nginx**: Limpar com `rm -rf /var/cache/nginx/* && systemctl reload nginx`
- **Fail2ban**: IP 177.130.229.73 na whitelist (caso seja bloqueado: `fail2ban-client set sshd unbanip IP`)

### ğŸ“… HistÃ³rico de MudanÃ§as

- **12/01/2026 21:18**: Sistema totalmente funcional apÃ³s correÃ§Ã£o de Nginx
- **12/01/2026 20:49**: Deploy inicial dos arquivos Vue
- **12/01/2026 17:51**: CriaÃ§Ã£o de oportunidades demo no banco
- **22/12/2025**: Sistema de notificaÃ§Ãµes SSE implementado
- **11/12/2025**: Analytics e relatÃ³rios completos

---

**Criado por:** GitHub Copilot  
**Data:** 12 de janeiro de 2026  
**VersÃ£o do Sistema:** 1.0.0  
**Status:** âœ… ProduÃ§Ã£o EstÃ¡vel
