<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>Dashboard</h1>
      </div>
    </div>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    
    <!-- Filtros -->
    <div class="row mb-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <h3 class="card-title mb-0"><i class="fas fa-filter"></i> Filtros</h3>
            <button type="button" class="btn btn-sm btn-outline-secondary" (click)="toggleFilters()">
              <i class="fas" [ngClass]="showFilters ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </button>
          </div>
          <div class="card-body" *ngIf="showFilters">
            <div class="row">
              <div class="col-md-4">
                <div class="form-group">
                  <label>Período</label>
                  <select class="form-control" [(ngModel)]="selectedPeriod" (change)="onFilterChange()">
                    <option *ngFor="let period of periods" [value]="period.value">{{ period.label }}</option>
                  </select>
                </div>
              </div>
              <div class="col-md-4" *ngIf="vendedores.length > 0">
                <div class="form-group">
                  <label>Vendedor</label>
                  <select class="form-control" [(ngModel)]="selectedVendedor" (change)="onFilterChange()">
                    <option value="all">Todos</option>
                    <option *ngFor="let vendedor of vendedores" [value]="vendedor.id">{{ vendedor.nome }}</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center my-5">
      <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
      <p class="mt-3">Carregando dados...</p>
    </div>

    <!-- Estado vazio / erro leve -->
    <div *ngIf="!loading && !dashboardData" class="empty-state text-center my-5 fade-in">
      <p class="mb-3" *ngIf="!error">Nenhum dado carregado. Verifique a API ou tente novamente.</p>
      <p class="mb-3 text-danger" *ngIf="error">{{ error }} (fallback DEV aplicado se disponível)</p>
      <button type="button" class="btn btn-primary btn-sm" (click)="loadDashboard()">
        <i class="fas fa-redo"></i> Recarregar
      </button>
    </div>

    <!-- Dashboard Content -->
    <div *ngIf="!loading && dashboardData">
      
      <!-- Small Boxes (Componentized) -->
      <div class="row fade-in">
        <div class="col-lg-3 col-6">
          <app-small-box title="Total de Clientes" [value]="dashboardData.resumo.total_clientes" icon="fas fa-users" color="info"></app-small-box>
        </div>
        <div class="col-lg-3 col-6">
          <app-small-box title="Leads Ativos" [value]="dashboardData.resumo.leads_ativos" icon="fas fa-user-plus" color="warning"></app-small-box>
        </div>
        <div class="col-lg-3 col-6">
          <app-small-box title="Vendas do Mês" [value]="dashboardData.resumo.vendas_mes" icon="fas fa-shopping-cart" color="success"></app-small-box>
        </div>
        <div class="col-lg-3 col-6">
          <app-small-box title="Receita do Mês" [value]="dashboardData.resumo.receita_mes" icon="fas fa-dollar-sign" color="danger"></app-small-box>
        </div>
      </div>

      <!-- Charts -->
      <div class="row fade-in">
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-line"></i> Vendas</h3>
            </div>
            <div class="card-body">
              <canvas baseChart [data]="vendasChartData" [options]="chartOptions" type="line"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-area"></i> Leads</h3>
            </div>
            <div class="card-body">
              <canvas baseChart [data]="leadsChartData" [options]="chartOptions" type="line"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-bar"></i> Pipeline</h3>
            </div>
            <div class="card-body">
              <canvas baseChart [data]="pipelineChartData" [options]="chartOptions" type="bar"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Info Boxes -->
      <div class="row fade-in">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-info-circle"></i> Sistema</h3>
            </div>
            <div class="card-body">
              <app-info-box title="Nome" [value]="dashboardData.sistema.nome" icon="fas fa-server" color="primary"></app-info-box>
              <app-info-box title="Versão" [value]="dashboardData.sistema.versao" icon="fas fa-code" color="info"></app-info-box>
              <app-info-box title="Última Atualização" [value]="dashboardData.sistema.ultimo_update" icon="fas fa-clock" color="warning"></app-info-box>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-chart-pie"></i> Métricas</h3>
            </div>
            <div class="card-body">
              <app-info-box title="Taxa de Conversão" [value]="dashboardData.metricas.conversao_leads.taxa_conversao + '%'" icon="fas fa-percentage" color="success" [progressPercent]="dashboardData.metricas.conversao_leads.taxa_conversao"></app-info-box>
              <app-info-box title="Ticket Médio" [value]="dashboardData.metricas.tickets_medio.valor" icon="fas fa-dollar-sign" color="info"></app-info-box>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Table -->
      <div class="row" *ngIf="dashboardData.performance_vendedores && dashboardData.performance_vendedores.length > 0">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title"><i class="fas fa-trophy"></i> Performance dos Vendedores</h3>
            </div>
            <div class="card-body table-responsive p-0">
              <table class="table table-striped table-valign-middle">
                <thead>
                  <tr>
                    <th>Vendedor</th>
                    <th>Vendas</th>
                    <th>Leads</th>
                    <th>Conversão</th>
                    <th>Atingimento</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let vendedor of dashboardData.performance_vendedores">
                    <td>{{ vendedor.nome }}</td>
                    <td>{{ vendedor.vendas }}</td>
                    <td>{{ vendedor.leads }}</td>
                    <td>{{ vendedor.conversao }}%</td>
                    <td>
                      <span class="badge" 
                            [ngClass]="{
                              'badge-success': vendedor.atingimento >= 100,
                              'badge-warning': vendedor.atingimento >= 80 && vendedor.atingimento < 100,
                              'badge-danger': vendedor.atingimento < 80
                            }">
                        {{ vendedor.atingimento }}%
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Activities (refatorado sem classes AdminLTE) -->
      <div class="row" *ngIf="dashboardData.atividade_recente && dashboardData.atividade_recente.length > 0">
        <div class="col-12">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="card-title mb-0"><i class="fas fa-history"></i> Atividades Recentes</h3>
            </div>
            <div class="card-body">
              <ul class="activity-list list-unstyled m-0 p-0">
                <li class="activity-item d-flex" *ngFor="let atividade of dashboardData.atividade_recente" [ngClass]="atividade.tipo">
                  <div class="activity-icon me-3">
                    <i class="fas" [ngClass]="{
                      'fa-user text-primary': atividade.tipo === 'cliente',
                      'fa-user-plus text-warning': atividade.tipo === 'lead',
                      'fa-shopping-cart text-success': atividade.tipo === 'venda'
                    }"></i>
                  </div>
                  <div class="activity-content flex-grow-1">
                    <div class="activity-time"><i class="fas fa-clock"></i> {{ atividade.tempo }}</div>
                    <div class="activity-text">{{ atividade.descricao }}</div>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>


