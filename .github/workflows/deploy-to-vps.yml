name: deploy-to-vps

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Laravel Docker image
        run: |
          cd wk-crm-laravel
          docker build -t wk-crm-laravel:${{ github.sha }} -t wk-crm-laravel:latest .

      - name: Save Docker image
        run: |
          docker save wk-crm-laravel:${{ github.sha }} | gzip > wk-crm-laravel.tar.gz

      - name: Copy image to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sudo apt-get update && sudo apt-get install -y sshpass
          sshpass -p "$VPS_PASSWORD" scp -o StrictHostKeyChecking=no wk-crm-laravel.tar.gz $VPS_USER@$VPS_HOST:/tmp/

      - name: Deploy on VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            set -e
            
            # Backup current state
            cd /opt/wk-crm
            docker-compose ps > /tmp/docker-state-backup.txt
            
            # Load new image
            docker load < /tmp/wk-crm-laravel.tar.gz
            rm /tmp/wk-crm-laravel.tar.gz
            
            # Update docker-compose with new image tag
            cd /opt/wk-crm
            sed -i 's/image: wk-crm-laravel:.*/image: wk-crm-laravel:${{ github.sha }}/' docker-compose.yml || true
            
            # Run migrations and restart
            docker-compose up -d --no-deps wk-crm-laravel
            docker-compose exec -T wk-crm-laravel php artisan migrate --force
            docker-compose exec -T wk-crm-laravel php artisan config:cache
            docker-compose exec -T wk-crm-laravel php artisan route:cache
            
            # Health check
            sleep 5
            if ! curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
              echo "Health check failed, rolling back..."
              docker-compose down wk-crm-laravel
              docker-compose up -d wk-crm-laravel
              exit 1
            fi
            
            echo "Deploy successful!"
          ENDSSH

      - name: Cleanup old images on VPS
        if: success()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PASSWORD: ${{ secrets.VPS_PASSWORD }}
        run: |
          sshpass -p "$VPS_PASSWORD" ssh -o StrictHostKeyChecking=no $VPS_USER@$VPS_HOST << 'ENDSSH'
            docker image prune -f --filter "label!=keep"
          ENDSSH

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deploy completed successfully"
          else
            echo "❌ Deploy failed - check logs and rollback if needed"
          fi
